//
//  Year2024Day06.swift
//  advent-of-code
//
//  Created by cdann on 12/12/24.
//

import ArgumentParser

struct Year2024Day6: ParsableCommand {
  static let configuration = CommandConfiguration(
    commandName: "6",
    abstract: "Day 6 Challenge",
    shouldDisplay: true,
    aliases: ["Day6"]
  )
  
  @OptionGroup var input: InputFileArgument

  mutating func run() throws {
    let input = try self.input.getInput() ?? Self.defaultInput
    var map: [[Character]] = input.split(separator: "\n").map(Array.init)

    let gInitial = locateGuard(map: map)!

    var g = gInitial
    while advanceGuard(&g, map: &map) {}

    let guardPositions = map.reduce(0) { partialResult, line in
      partialResult + line.reduce(0) { partialResult, char in
        char == "X" ? partialResult + 1 : partialResult
      }
    }

    print("Part 1 - Guard Positions \(guardPositions)")

    var loops = 0
    for y in map.indices {
      for x in map[y].indices {
        guard
          (gInitial.x != x || gInitial.y != y),
          map[y][x] == "X"
        else { continue }
        
        var mapCopy = map
        mapCopy[y][x] = "#"
        if detectGuardLoop(initialGuard: gInitial, map: &mapCopy) {
          loops += 1
        }
      }
    }

    print("Part 2 - Guard Loops \(loops)")
  }

  // MARK: - Models
  
  enum Direction: Character {
    case north = "^"
    case east = ">"
    case south = "v"
    case west = "<"
  }

  struct Guard: Equatable {
    var x: Int
    var y: Int
    var direction: Direction
    
    var rotations: Int = 0
    
    func nextPosition() -> (x: Int, y: Int) {
      switch direction {
      case .north:
        return (x: x, y: y - 1);
      case .east:
        return (x: x + 1, y: y);
      case .south:
        return (x: x, y: y + 1);
      case .west:
        return (x: x - 1, y: y);
      }
    }
    
    mutating func stepForward() {
      let (nextX, nextY) = nextPosition()
      x = nextX
      y = nextY
    }
    
    mutating func rotateRight() {
      switch direction {
      case .north:
        direction = .east
      case .east:
        direction = .south
      case .south:
        direction = .west
      case .west:
        direction = .north
      }
    }
  }

  struct LoopError: Error {}

  func locateGuard(map: [[Character]]) -> Guard? {
    for y in map.indices {
      for x in map[y].indices {
        if let direction = Direction(rawValue: map[y][x]) {
          return Guard(x: x, y: y, direction: direction)
        }
      }
    }
    return nil
  }

  func advanceGuard(_ g: inout Guard, map: inout [[Character]]) -> Bool {
    let nextPosition = g.nextPosition()
    
    guard
      map.indices.contains(nextPosition.y),
      map[nextPosition.y].indices.contains(nextPosition.x)
    else {
      map[g.y][g.x] = "X"
      return false
    }
    
    if map[nextPosition.y][nextPosition.x] == "#" {
      g.rotateRight()
    } else {
      map[g.y][g.x] = "X"
      g.stepForward()
    }
    
    return true
  }

  func advanceGuardLoop(_ g: inout Guard, map: inout [[Character]]) -> Bool {
    let nextPosition = g.nextPosition()
    
    guard
      map.indices.contains(nextPosition.y),
      map[nextPosition.y].indices.contains(nextPosition.x)
    else {
      return false
    }
    
    if map[nextPosition.y][nextPosition.x] == "#" {
      g.rotateRight()
    } else {
      g.stepForward()
    }
    
    return true
  }

  func detectGuardLoop(initialGuard: Guard, map: inout [[Character]]) -> Bool {
    var g1 = initialGuard
    var g2 = initialGuard

    while advanceGuardLoop(&g1, map: &map),
          advanceGuardLoop(&g2, map: &map),
          advanceGuardLoop(&g2, map: &map) {
      if g1 == g2 {
        return true
      }
    }
    return false
  }

  // MARK: - Default Input
  static let defaultInput = """
..#....##....................#...#...#..........................................................................................#.
.....#..............................................#....#.....#.....#..............................#.......#...#.............#...
............#.#.........................................#...................#..#...........................###..........#.....#...
.....#.....#.............#...........................................................#.#.................#.........#..............
.......................#...........................#................#...........#......#.....................#...#.......#....#...
...#........................................#....................#.......#........##.##.........#.........................#.......
......#...........#....................#...........#.............................#........................#....................#..
...........................#...................................#...............#.........................................#........
........#...........#................................................................#............#...............................
.........................#......#.......#..............#......#.................#..................#...................#..........
............#......................................................#..............................#........#....#.................
........#.....................................................................#..............#....................................
..#............................#.................#.#............#.................................................................
...#................#.....................#.................................................#...................#.................
......#...................#........................................................................................#..#...........
.....................##..#........................................#...................#............#.....#........................
.......#.................#..........#...........................#.......#..............#..........................................
.............#........#........#..........#................#.........#.##.................................#.......#...........#...
.#..............................................................#..#.....................................#.................##.....
.........................#.#.......#.#..................................................#....................#.......#.........#..
.............#................................................#..#................#.............#.....#...........................
.............................................#..............#.....#..............#.........#......................................
................#............#............................#...........#.#.........................................................
...#.................................#.......#.........................................#..........................................
...............................#.....................................................................#.....#.........##...........
...................#...................................#.....................#.............................#..#...#...............
......#.......................................................#............................#......#.................#.#...........
...........................................#........................#.........#........................##......#..................
....#.......................#...................#.....#....................#......................................................
.....#......#....#..........#............#........#...............................................................................
.........#.................................................................................#........#.........................#...
........................#................................#........#...#......#........#..........#.#.......#.........#.........#.#
.##......#..#......#............#.#.................................#..............................#.........#....................
......#..............................#..........#.........#.....#....................................#...........................#
..#.........................#.#...#............................................#.#.......................................##.......
#.........................#......................#.............#..#.#...#....#.....#.#...#......#........................#........
.#............................#.................................#....#..............................#........#..........#.........
..........#.........#.....#.....#......................#............................................#.............................
.........................#...#.............................#..............................................#......#.#..............
....................#................................................................................................#............
...#........#......................#..#...........#..#.........#.................................................#................
...................#....................#..............#......................#..............#........#......................#....
.............#..................................................................................#................#.....##.........
.#.............................#........#................#..#..#.....#...........###..............................................
.......................................................#.........................#.............................#..................
...........................##.............#.........................................................#.......................#.....
......#.......##.........#..................................................................#.#..#.........#.........#.......#....
..#...........#..........#........#....#..........#..................#.............#.............#................................
#................................##...........#......#....##......#..#.....................................#.........#..#.........
...#...#.#.......................#......................................#.........#......#...............#........................
..#...#.......................................................#..................#.........................................#......
...#.....#.....#..........#....................#..................#.........................#...............#...#..#....#.........
..........#................................#...................#..#...........#.........#....................................#....
..............#........#............................#..................................................................#........#.
............................................................#.....##.................................#............................
...##..............................................#..........................................#.............................#.##..
...#...........................................................................#......#.....................#.#...................
.........#.............................................................................##.....................................#.#.
...............#.....#........#..#................................................................................................
#...........................#.#..............................#........^......#.................................#.....#............
...#...#.........................................#......................#.#.......................................................
.#......#...........................#.............................................................................................
.....#.........#.......#..#........#.....#.....................#......#........................................#...#..............
....#....................................................................................................#........................
#..............#.......................#.........................................#...............................#.#..............
................................#..............................#.......................................................#....#.....
....#............................#............................................................#.....#........#...................#
...........#...#............................#....................#.......................................................#........
.#.....................................................................................................#.....#....................
.#.......#..............#.....................#.....................#............#........................#.......................
............................#...#................................................#................................#...............
..........#...............#..........................#................#.........................#.......#.#.......................
..............................#.............................................................................................#.....
..............................................#....#...............................................#.....#........................
.........#...................................................#...............#.....#................#.............................
...........................................#..............#....................................................#........#.#.......
..........................#...........#.#...#.....................................#......................#...........#..#.........
....#...............#..............#.............................#....#.....#....#................................................
....#.#...........#..............#.................................................................#..............................
.....#.......#..........................................................................................#.#.......................
................................................#..#..............................................................................
.#....#..............................#..........#................#.............................................................#..
....#.......................#........#.....#..............#...............#..#........................................#...........
...........................................................................#......................................................
...#.........#..#.......................................................#..#..............................#.......................
.............#...................................................................#.......................#...#...........#........
.....#........................#....................#...................#................................#.........................
.........#......#...........................................#.......#....................#........................................
...........................................................#...........................#.............................#............
..........................#..............#........................................#......#.........#.#.............#........#.....
.........#..............#..#...........................#......#.......................#..#..#.............#.......................
...#.................#...............................................................................................#............
................#.....#.#...........................#......................#....................................#...#.#...........
..................#.....#...............................................................#............................#....#..#....
...............................#................................................#.............#..........................#........
..#...........#................................................#.........................................#...............##......#
...............................#..................##..#...........................................#................#..............
...........................#........#.........#....................................................#......#......#................
..................................#................#..................#.....#..................#...................#.....#........
.......#...#................................................................##...........................................#........
..............#..#.......#............................#...................#....#...........................#..#......#............
...............#............#................................................................................#..............#.....
...............#.....#........................#.........#.........#...#................#....#.........#...........................
................................#........................................................................#.........#..............
.............#..................#...#................................#..............#................................#.........#..
.....................#.#.............................#......#..................................#.........##....#.................#
......#.........#...#.................................#..........#.#......................#.......#........#......................
.....#....................#......................#.........#.....................#.........................................#......
.........##.....................#....#.#....#....................................................................................#
.................................................#.#....#....................#...............##..#................................
..##.......#........#.......................#.....................................................................#...........#.##
..#...........##........##......#..........#....................#.....#.....#..................#.....#............................
..........................#.......................#.....#.........................................................................
.#...........................#..............#...#...........#.....#.......#....#............#.....#..................#....#......#
.................#.......................#....#...#..................#......#............................#.....................#..
.....##..#........#........................#......#........................#....#......................##.........................
...#....................................................................................................#.......................#.
.......................#...#..............#..................#............#.#.........#....#...#..................................
...........#.......................#.......................#.......#....#.....#..................#...................#............
..................#......................................................................#.......#..........................#.....
.......#..................#.............#..#........##........#..##........##.....##...#................#..#.......#..............
........#................#..............................#..#......................................................................
...................#....#.........................#...........#.#......##.........#.#..................#..#.#....#........#.......
.............#......#.....................................................#.......................................................
.........................#.......................#..................#.........................#...............................#..#
..#...........................#............#.................##...#................#.................#................#...........
.....#...............#.....#..........#..................................#.#........................#.....###.#...................
...............................................#.............#......................................................#.............
......#......................#..............#.................#.#........#.................#......................................
........................#.......................................#....................#.......#.#..#...............................
"""
}
